<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Halo Wars JS - Single Player Campaign</title> 
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Define global functions early for onclick attributes -->
    <script>
        // Global variable for selected difficulty
        let selectedDifficulty = 'normal';
        // Make it accessible globally for AI code
        window.selectedDifficulty = selectedDifficulty;
        
        // Game initialization guard
        let gameInitialized = false;
        let missionBriefingStarted = false;
        
        // Define selectDifficulty function globally for onclick attributes
        function selectDifficulty(difficulty) {
            console.log('selectDifficulty called with:', difficulty);
            selectedDifficulty = difficulty;
            window.selectedDifficulty = difficulty; // Update window property too
            
            // Remove selected class from all difficulty buttons
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selected class to clicked button
            const targetBtn = document.getElementById(difficulty + 'Btn');
            if (targetBtn) {
                targetBtn.classList.add('selected');
                console.log('Selected:', difficulty);
            }
            
            // Update current difficulty display
            const currentDifficultyElement = document.getElementById('currentDifficulty');
            if (currentDifficultyElement) {
                currentDifficultyElement.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
            }
        }
        
        // Define startMissionBriefing function globally
        function startMissionBriefing() {
            console.log('Starting mission briefing...');
            
            // Prevent multiple briefing countdowns
            if (missionBriefingStarted) {
                console.warn('Mission briefing already started, ignoring duplicate request');
                return;
            }
            
            missionBriefingStarted = true;
            
            document.getElementById('campaignMenu').style.display = 'none';
            document.getElementById('missionBriefing').style.display = 'block';
            
            let countdown = 3;
            const countdownElement = document.getElementById('countdownTimer');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    startSinglePlayerGame();
                }
            }, 1000);
        }
        
        // Define startSinglePlayerGame function globally
        function startSinglePlayerGame() {
            console.log('Starting single-player game...');
            
            // Prevent multiple initialization
            if (gameInitialized) {
                console.warn('Game already initialized, ignoring duplicate start request');
                return;
            }
            
            gameInitialized = true;
            
            // Hide lobby interface and show game
            document.getElementById('singlePlayerLobby').style.display = 'none';
            
            // Show game canvas and UI
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('gameUI').style.display = 'block';
            
            // Initialize game (this will be called from the main script later)
            if (window.initializeSinglePlayerGame) {
                window.initializeSinglePlayerGame();
            } else {
                console.log('Game initialization function not ready yet, will be called later');
            }
        }
        
        // Define goBackToMenu function globally
        function goBackToMenu() {
            console.log('Going back to main menu...');
            window.location.href = 'index.html';
        }
    </script>
</head>
<body>
    <div id="gameContainer">
        <!-- Single Player Lobby Interface -->
        <div id="singlePlayerLobby" class="lobby-interface">
            <div class="lobby-container">
                <h1>üéÆ Halo Wars JS - Single Player</h1>
                
                <div id="campaignMenu" class="lobby-section">
                    <div class="campaign-info">
                        <h2>üèîÔ∏è Operation: Fortress Assault</h2>
                        <p>An enemy AI has constructed a heavily fortified base with defensive turrets and a standing army. 
                        Your mission is to build your forces and destroy their headquarters.</p>
                        
                        <div class="mission-objectives">
                            <h3>üìã Mission Objectives:</h3>
                            <ul>
                                <li>‚úì Build your economy and military</li>
                                <li>‚úì Destroy the enemy AI base</li>
                                <li>‚ö†Ô∏è Defend against AI attack waves</li>
                                <li>üíÄ Survive the heavily defended enemy turrets</li>
                            </ul>
                        </div>
                        
                        <div class="difficulty-selection">
                            <h3>üéØ Select Difficulty:</h3>
                            <div class="difficulty-buttons">
                                <button id="easyBtn" class="difficulty-btn easy-btn" onclick="selectDifficulty('easy')">
                                    <div class="difficulty-icon">üòä</div>
                                    <div class="difficulty-name">Easy</div>
                                    <div class="difficulty-desc">1 vs 1 - Single AI opponent</div>
                                </button>
                                <button id="normalBtn" class="difficulty-btn normal-btn selected" onclick="selectDifficulty('normal')">
                                    <div class="difficulty-icon">üòê</div>
                                    <div class="difficulty-name">Normal</div>
                                    <div class="difficulty-desc">1 vs 2 - Two AI opponents</div>
                                </button>
                                <button id="hardBtn" class="difficulty-btn hard-btn" onclick="selectDifficulty('hard')">
                                    <div class="difficulty-icon">üò†</div>
                                    <div class="difficulty-name">Hard</div>
                                    <div class="difficulty-desc">1 vs 3 - Three AI opponents</div>
                                </button>
                                <button id="legendaryBtn" class="difficulty-btn legendary-btn" onclick="selectDifficulty('legendary')">
                                    <div class="difficulty-icon">üíÄ</div>
                                    <div class="difficulty-name">Legendary</div>
                                    <div class="difficulty-desc">9 AIs surround you on 5km map - survive!</div>
                                </button>
                            </div>
                        </div>
                        
                        <div class="player-setup">
                            <div class="nickname-section">
                                <input type="text" id="playerNickname" placeholder="Enter your commander name" maxlength="20" value="Commander">
                            </div>
                        </div>
                    </div>
                    
                    <div class="campaign-actions">
                        <button id="startSinglePlayerBtn" class="lobby-btn primary large" onclick="startMissionBriefing()">üöÄ Start Mission</button>
                                            <button id="backToMenuBtn" class="lobby-btn secondary large" onclick="goBackToMenu()">üè† Back to Menu</button>
                    </div>
                </div>
                
                <div id="missionBriefing" class="lobby-section" style="display: none;">
                    <h2>üéØ Mission Briefing</h2>
                    <div class="briefing-content">
                        <div class="briefing-text">
                            <p><strong>Intelligence Report:</strong></p>
                            <ul>
                                <li>Enemy base located in the eastern sector</li>
                                <li>6 defensive turrets protecting the perimeter</li>
                                <li>Mixed enemy force: Marines, Warthogs, and Scorpion tanks</li>
                                <li>Enemy will launch periodic attack waves</li>
                                <li>Expect increased resistance over time</li>
                            </ul>
                            
                            <p><strong>Recommended Strategy:</strong></p>
                            <ul>
                                <li>Establish economy first (Supply Depots and Reactors)</li>
                                <li>Build Barracks to train units</li>
                                <li>Consider defensive turrets for your base</li>
                                <li>Use mixed unit composition for balanced attacks</li>
                            </ul>
                        </div>
                        
                        <div class="countdown-display">
                            <div class="countdown-text">Mission starts in:</div>
                            <div id="countdownTimer" class="countdown-number">3</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Full Screen Canvas -->
        <canvas id="gameCanvas"></canvas>
        
        <!-- Game UI (same as multiplayer) -->
        <div id="gameUI" style="display: none;">
            <!-- Top Resource Bar -->
            <div id="topResourceBar" class="top-bar">
                <div id="resourceDisplay">
                    <div class="resource-item">
                        <span class="resource-icon">üí∞</span>
                        <span class="resource-label">Supplies:</span>
                        <span id="supplies" class="resource-value">1000</span>
                    </div>
                    <div class="resource-item">
                        <span class="resource-icon">‚ö°</span>
                        <span class="resource-label">Power:</span>
                        <span id="power" class="resource-value">0</span>
                    </div>
                    <div class="resource-item">
                        <span class="resource-icon">üë•</span>
                        <span class="resource-label">Population:</span>
                        <span class="current-pop">0</span>/<span class="max-pop">25</span>
                    </div>
                </div>
                
                <!-- Mission Status -->
                <div id="missionStatus" class="mission-status">
                    <!-- Temporarily commented out - will be re-enabled later
                    <div class="status-item">
                        <span class="status-label">Next Wave:</span>
                        <span id="nextWaveTimer" class="status-value">45s</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Difficulty:</span>
                        <span id="currentDifficulty" class="status-value">Normal</span>
                    </div>
                    -->
                </div>
                
                <!-- Game Settings Button -->
                <div id="gameSettings" class="game-settings">
                    <button id="settingsBtn" class="settings-btn" title="Game Settings (ESC)">‚öôÔ∏è</button>
                </div>
            </div>

            <!-- Minimap -->
            <div id="minimapPanel" class="overlay-panel minimap-panel">
                <canvas id="minimap"></canvas>
                <div class="panel-title">Minimap</div>
                <div id="enemyBaseCounter" class="enemy-counter" style="display: none;">
                    <div class="counter-label">Enemy Bases Destroyed:</div>
                    <div class="counter-value">
                        <span id="basesDestroyed">0</span>/<span id="totalBases">9</span>
                    </div>
                </div>
            </div>

            <!-- Selected Entity Panel -->
            <div id="selectedEntityPanel" class="overlay-panel selected-entity-panel">
                <div id="selectedUnitsDisplay" style="display: none;"></div>
                <div id="selectedBuildingDisplay" style="display: none;"></div>
            </div>
            
            <!-- Building Queue Panel -->
            <div id="buildingQueuePanel" class="overlay-panel building-queue-panel" style="display: none;">
                <div class="panel-title">üèóÔ∏è Building Queue</div>
                
                <!-- Currently Building Section -->
                <div id="currentBuildingInfo" style="display: none;">
                    <div class="current-building-section">
                        <div class="section-title">Currently Building:</div>
                        <div class="building-queue-item in-progress">
                            <div class="queue-item-info">
                                <div class="queue-item-icon">üèóÔ∏è</div>
                                <div class="queue-item-details">
                                    <div id="currentBuildingName" class="queue-item-name">Building...</div>
                                    <div class="progress-bar">
                                        <div id="currentBuildingProgress" class="progress-fill" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <button class="queue-item-cancel">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <!-- Queued Buildings Section -->
                <div class="queued-section">
                    <div class="section-title">Queue:</div>
                    <div id="queuedBuildingsList" class="building-queue-list">
                        <!-- Queued buildings will be added here -->
                    </div>
                    <div id="emptyQueueMessage" class="empty-message">No buildings queued</div>
                </div>
            </div>
        </div> <!-- End Game UI -->
    </div>

    <!-- Include Scripts in correct order -->
    <script src="js/math-utils.js"></script>
    <script src="js/client-logger.js"></script>
    <script src="js/resources.js"></script>
    <script src="js/game-engine.js"></script>
    <script src="js/units.js"></script>
    <script src="js/buildings.js"></script>
    <script src="js/building-spots.js"></script>
    <script src="js/renderer.js"></script>
    <script src="js/input-handler.js"></script>
    <script src="js/ai-opponent.js"></script>
    <script src="js/game.js"></script>
    
    <!-- Single-player initialization -->
    <script>
        console.log('=== Single Player Mode ===');
        
        // selectDifficulty function is already defined globally in head section
        
        // selectedDifficulty is already declared globally in head
        let aiOpponents = []; // Array to hold multiple AI opponents
        window.aiOpponents = aiOpponents; // Make globally accessible for collision detection
        let gameStartTime = null; // Track when game started
        let missionStartTime = null;
        let gameStats = { unitsTrained: 0, enemiesDefeated: 0, buildingsBuilt: 0 };
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up single-player interface...');
            console.log('Page loaded, DOM ready');
            
            // Test if basic JavaScript is working
            console.log('Testing JavaScript functionality...');
            
            // Difficulty selection with debugging
            const easyBtn = document.getElementById('easyBtn');
            const normalBtn = document.getElementById('normalBtn');
            const hardBtn = document.getElementById('hardBtn');
            const legendaryBtn = document.getElementById('legendaryBtn');
            
            console.log('Found buttons:', { easyBtn, normalBtn, hardBtn, legendaryBtn });
            
            if (easyBtn) {
                easyBtn.addEventListener('click', () => {
                    console.log('Easy button clicked');
                    selectDifficulty('easy');
                });
                console.log('Easy button event listener added');
            }
            
            if (normalBtn) {
                normalBtn.addEventListener('click', () => {
                    console.log('Normal button clicked');
                    selectDifficulty('normal');
                });
                console.log('Normal button event listener added');
            }
            
            if (hardBtn) {
                hardBtn.addEventListener('click', () => {
                    console.log('Hard button clicked');
                    selectDifficulty('hard');
                });
                console.log('Hard button event listener added');
            }
            
            if (legendaryBtn) {
                legendaryBtn.addEventListener('click', () => {
                    console.log('Legendary button clicked');
                    selectDifficulty('legendary');
                });
                console.log('Legendary button event listener added');
            }

            // Additional event listeners
            
            // Main buttons
            document.getElementById('startSinglePlayerBtn').addEventListener('click', startMissionBriefing);
            document.getElementById('backToMenuBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up single-player interface...');
            
            // Use onclick attributes as backup - add them directly to buttons
            const buttons = [
                { id: 'easyBtn', difficulty: 'easy' },
                { id: 'normalBtn', difficulty: 'normal' },
                { id: 'hardBtn', difficulty: 'hard' },
                { id: 'legendaryBtn', difficulty: 'legendary' }
            ];
            
            buttons.forEach(({ id, difficulty }) => {
                const btn = document.getElementById(id);
                if (btn) {
                    // Multiple ways to ensure click works
                    btn.onclick = () => selectDifficulty(difficulty);
                    btn.addEventListener('click', () => selectDifficulty(difficulty));
                    console.log(`Setup ${difficulty} button`);
                }
            });
            
            // Main buttons - these functions are now defined globally in head
            document.getElementById('startSinglePlayerBtn').addEventListener('click', startMissionBriefing);
            document.getElementById('backToMenuBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
        });
        
        // Initialize single player game - called from global startSinglePlayerGame function
        window.initializeSinglePlayerGame = function() {
            console.log('=== STARTING SINGLE-PLAYER GAME ===');
            console.log('Selected difficulty:', selectedDifficulty);
            console.log('Window.selectedDifficulty:', window.selectedDifficulty);
            
            // Prevent duplicate initialization
            if (window.game && window.game.isInitialized) {
                console.warn('Single-player game already initialized, skipping duplicate initialization');
                return;
            }
            
            // Hide lobby, show game UI
            document.getElementById('singlePlayerLobby').style.display = 'none';
            document.getElementById('gameUI').style.display = 'block';

            missionStartTime = Date.now();
            gameStartTime = Date.now(); // Track game start time for settings modal
            
            // Prevent auto-initialization by setting a temporary flag
            window.singlePlayerInitializing = true;
            
            // Create game instance
            window.game = new Game();
            window.game.isMultiplayer = false;
            window.game.playerTeam = 'player';
            
            // Clear the flag
            delete window.singlePlayerInitializing;
            
            // Manually initialize game systems in the right order
            console.log('Manually initializing game systems for single-player...');
            
            // Ensure GameEngine is available
            if (typeof GameEngine === 'undefined') {
                console.error('GameEngine not defined! Waiting for scripts to load...');
                setTimeout(() => window.initializeSinglePlayerGame(), 100);
                return;
            }
            
            // Create GameEngine first
            window.game.engine = new GameEngine();
            
            // Set world size based on difficulty BEFORE creating entities
            if (selectedDifficulty === 'legendary') {
                window.game.engine.setWorldSize(5000, 5000);
                console.log('‚úì Legendary mode: World size set to 5000x5000 with updated camera bounds');
                
                // Show enemy base counter for legendary mode
                document.getElementById('enemyBaseCounter').style.display = 'block';
                document.getElementById('totalBases').textContent = '9';
                document.getElementById('basesDestroyed').textContent = '0';
            } else if (selectedDifficulty === 'hard') {
                // Hide counter for other difficulties
                document.getElementById('enemyBaseCounter').style.display = 'none';
                
                // Larger map for 1v3 scenario
                window.game.engine.setWorldSize(3000, 3000);
                console.log('‚úì Hard mode: World size set to 3000x3000');
            } else if (selectedDifficulty === 'normal') {
                // Hide counter for other difficulties
                document.getElementById('enemyBaseCounter').style.display = 'none';
                
                // Medium map for 1v2 scenario
                window.game.engine.setWorldSize(2500, 2500);
                console.log('‚úì Normal mode: World size set to 2500x2500');
            } else {
                // Hide counter for other difficulties
                document.getElementById('enemyBaseCounter').style.display = 'none';
                
                // Compact map for 1v1 scenario
                window.game.engine.setWorldSize(2000, 2000);
                console.log('‚úì Easy mode: World size set to 2000x2000');
            }
            
            // Initialize other systems
            window.game.resources = new ResourceManager();
            window.game.uiRenderer = new UIRenderer();
            window.game.inputHandler = new InputHandler(window.game.engine, window.game);
            
            // Set up UI event handlers
            window.game.setupUIHandlers();
            
            // Initialize minimap with proper aspect ratio
            window.game.initializeMinimap();
            
            window.game.isInitialized = true;
            
            // Setup our custom single-player state
            setupSinglePlayerGameState();
            
            // Initialize AI opponents based on difficulty
            console.log('=== INITIALIZING AI OPPONENTS ===');
            console.log('Difficulty:', selectedDifficulty);
            
            if (selectedDifficulty === 'legendary') {
                console.log('Setting up legendary mode with 9 AI opponents');
                // Create 9 individual AI opponents on the same team for legendary mode
                for (let i = 0; i < 9; i++) {
                    const aiOpponent = new AIOpponent('enemy', `legendary_ai_${i}`); // Same team, unique IDs
                    aiOpponent.setDifficulty(selectedDifficulty);
                    aiOpponent.aiIndex = i; // For unique positioning around the circle
                    aiOpponents.push(aiOpponent);
                    console.log(`‚úì Created legendary AI opponent ${i + 1} with ID: ${aiOpponent.aiId}`);
                }
                
                // Initialize all AI bases with delay
                setTimeout(() => {
                    console.log('Initializing legendary AI bases...');
                    aiOpponents.forEach((ai, index) => {
                        setTimeout(() => {
                            ai.initializeLegendaryBase(index);
                            ai.start();
                            console.log(`‚úì AI opponent ${index + 1} started on team 'enemy'`);
                        }, index * 500); // Stagger initialization
                    });
                }, 1000);
                
            } else {
                // Create multiple AI opponents based on difficulty
                let aiCount = 1; // Default for easy
                if (selectedDifficulty === 'normal') {
                    aiCount = 2;
                } else if (selectedDifficulty === 'hard') {
                    aiCount = 3;
                }
                
                console.log(`Setting up ${selectedDifficulty} mode with ${aiCount} AI opponents`);
                
                for (let i = 0; i < aiCount; i++) {
                    const aiOpponent = new AIOpponent('enemy', `${selectedDifficulty}_ai_${i}`);
                    aiOpponent.setDifficulty(selectedDifficulty);
                    aiOpponent.aiIndex = i;
                    aiOpponents.push(aiOpponent);
                    console.log(`‚úì Created ${selectedDifficulty} AI opponent ${i + 1} with ID: ${aiOpponent.aiId}`);
                }
                
                setTimeout(() => {
                    console.log(`Initializing ${selectedDifficulty} AI bases...`);
                    aiOpponents.forEach((ai, index) => {
                        setTimeout(() => {
                            ai.initializeBase();
                            ai.start();
                            console.log(`‚úì ${selectedDifficulty} AI opponent ${index + 1} started`);
                        }, index * 300); // Stagger initialization
                    });
                }, 1000);
            }

            // Start AI updates with performance-optimized intervals
            setTimeout(() => {
                console.log('Starting AI update loop...');
                setInterval(() => {
                    if (aiOpponents.length > 0 && window.game) {
                        aiOpponents.forEach(ai => {
                            if (ai) {
                                // Use slower update intervals for better performance
                                const updateDelta = 100;
                                ai.update(updateDelta);
                            }
                        });
                    }
                }, 1000); // Update every second for performance
                
                // Start game state monitoring for victory/defeat conditions
                setInterval(() => {
                    if (window.game && window.game.engine) {
                        if (selectedDifficulty === 'legendary') {
                            updateEnemyBaseCounter();
                        } else {
                            // For non-legendary difficulties, check victory/defeat separately
                            checkPlayerDefeat();
                            checkVictoryCondition();
                        }
                    }
                }, 1000); // Update every second
            }, 2000);
            
            // Start the game
            window.game.start();
            
            // Upgrade base functionality moved to HQ modal
            
            console.log('=== SINGLE-PLAYER GAME SETUP COMPLETE ===');
            
            // Add debug function for testing
            window.debugGameState = function() {
                console.log('=== CURRENT GAME STATE DEBUG ===');
                console.log('Selected Difficulty:', selectedDifficulty);
                console.log('World Size:', window.game.engine.worldWidth, 'x', window.game.engine.worldHeight);
                console.log('AI Opponents Count:', aiOpponents.length);
                console.log('Total Entities:', window.game.engine.entities.length);
                
                // Find player base
                const playerBase = window.game.engine.entities.find(e => e.team === 'player' && e.type === 'base');
                if (playerBase) {
                    console.log('Player Base Position:', playerBase.position);
                }
                
                // Find AI bases
                const aiBases = window.game.engine.entities.filter(e => e.team === 'enemy' && e.type === 'base');
                console.log('AI Bases:', aiBases.length);
                aiBases.forEach((base, i) => {
                    console.log(`  AI Base ${i + 1}:`, base.position);
                });
                
                console.log('Enemy Base Counter Visible:', document.getElementById('enemyBaseCounter').style.display !== 'none');
                console.log('=== END DEBUG ===');
            };
        }
        
        function setupSinglePlayerGameState() {
            let playerBaseX, playerBaseY;
            
            // Define unique positioning for each difficulty
            if (selectedDifficulty === 'legendary') {
                // Position player in the center of the 5000x5000 map
                playerBaseX = 2500; // Center of 5000x5000 map
                playerBaseY = 2500;
            } else if (selectedDifficulty === 'hard') {
                // Hard: 3000x3000 map - player in southwest corner
                playerBaseX = 400;
                playerBaseY = 2200;
            } else if (selectedDifficulty === 'normal') {
                // Normal: 2500x2500 map - player in bottom center
                playerBaseX = 1250;
                playerBaseY = 2000;
            } else {
                // Easy: 2000x2000 map - player in bottom left
                playerBaseX = 300;
                playerBaseY = 1500;
            }
            
            console.log(`Setting up player base for ${selectedDifficulty} mode at (${playerBaseX}, ${playerBaseY})`);
            
            // Create player base layout first
            const playerLayout = window.baseLayoutManager.createBaseLayout(playerBaseX, playerBaseY, 'player');
            console.log(`‚úì Player base layout created with ${playerLayout.getAvailableBuildingSlots()} building slots and ${playerLayout.getAvailableTurretSlots()} turret slots`);
            
            // Create player base
            const playerBase = BuildingFactory.create('base', playerBaseX, playerBaseY, 'player');
            playerBase.id = 'player_base_main';
            playerBase.isUnderConstruction = false;
            window.game.engine.addEntity(playerBase);
            
            // Create initial warthog using base rally point
            const spawnPos = playerBase.getRallyPoint();
            
            const warthog = UnitFactory.create('warthog', spawnPos.x, spawnPos.y, 'player');
            warthog.id = 'player_warthog_initial';
            window.game.engine.addEntity(warthog);
            
            // Position camera to show player base
            window.game.engine.setCameraPosition(playerBaseX - 300, playerBaseY - 300);
            
            // Add map-specific features based on difficulty
            addMapFeatures(selectedDifficulty, playerBaseX, playerBaseY);
            
            console.log(`‚úì Player base created at (${playerBaseX}, ${playerBaseY})`);
            console.log(`‚úì Total entities: ${window.game.engine.entities.length}`);
        }
        
        function addMapFeatures(difficulty, playerBaseX, playerBaseY) {
            // Add strategic elements and terrain features based on difficulty
            if (difficulty === 'easy') {
                // Easy: Simple 1v1 map with basic resources
                addResourceDeposits([
                    { x: playerBaseX + 200, y: playerBaseY - 150, type: 'energy' },
                    { x: 1400, y: 600, type: 'materials' }, // Near AI base
                    { x: 1000, y: 1000, type: 'credits' }   // Center contested
                ]);
                
            } else if (difficulty === 'normal') {
                // Normal: 2v1 map with strategic choke points
                addResourceDeposits([
                    { x: playerBaseX - 200, y: playerBaseY - 200, type: 'energy' },
                    { x: 1250, y: 1250, type: 'credits' },   // Center contested
                    { x: 1900, y: 800, type: 'materials' },  // Near AI base 1
                    { x: 600, y: 1200, type: 'energy' },     // Strategic position
                    { x: 2200, y: 1800, type: 'materials' }  // Near AI base 2
                ]);
                
                // Add defensive barriers
                addBarriers([
                    { x: 1250, y: 1500, width: 200, height: 50 }, // Central choke point
                    { x: 800, y: 800, width: 100, height: 100 }   // Strategic cover
                ]);
                
            } else if (difficulty === 'hard') {
                // Hard: 3v1 map with multiple contested areas
                addResourceDeposits([
                    { x: playerBaseX - 150, y: playerBaseX - 150, type: 'energy' },
                    { x: 1500, y: 1500, type: 'credits' },   // Center contested
                    { x: 2200, y: 800, type: 'materials' },  // Near AI base 1
                    { x: 800, y: 800, type: 'materials' },   // Near AI base 2
                    { x: 1500, y: 2200, type: 'energy' },    // Near AI base 3
                    { x: 1200, y: 1200, type: 'credits' },   // Secondary contested
                    { x: 1800, y: 1800, type: 'energy' }     // Third contested
                ]);
                
                // Add multiple defensive positions
                addBarriers([
                    { x: 1500, y: 1200, width: 150, height: 50 }, // North barrier
                    { x: 1200, y: 1500, width: 50, height: 150 }, // West barrier
                    { x: 1800, y: 1500, width: 50, height: 150 }, // East barrier
                    { x: 900, y: 900, width: 100, height: 100 },   // Strategic cover 1
                    { x: 2100, y: 2100, width: 100, height: 100 } // Strategic cover 2
                ]);
                
            } else if (difficulty === 'legendary') {
                // Legendary: Massive 9v1 map with rich center and defended outer ring
                addResourceDeposits([
                    // Central resource cluster (heavily contested)
                    { x: 2500, y: 2300, type: 'credits' },
                    { x: 2700, y: 2500, type: 'energy' },
                    { x: 2300, y: 2700, type: 'materials' },
                    { x: 2600, y: 2600, type: 'credits' },
                    { x: 2400, y: 2400, type: 'energy' },
                    
                    // Ring of resources near AI bases
                    { x: 4000, y: 2500, type: 'materials' },
                    { x: 3500, y: 1000, type: 'energy' },
                    { x: 2500, y: 750, type: 'credits' },
                    { x: 1500, y: 1000, type: 'materials' },
                    { x: 1000, y: 2500, type: 'energy' },
                    { x: 1500, y: 4000, type: 'credits' },
                    { x: 2500, y: 4250, type: 'materials' },
                    { x: 3500, y: 4000, type: 'energy' },
                    { x: 4000, y: 3000, type: 'credits' }
                ]);
                
                // Add defensive fortifications around the center
                addBarriers([
                    { x: 2200, y: 2200, width: 200, height: 50 },
                    { x: 2600, y: 2200, width: 200, height: 50 },
                    { x: 2200, y: 2600, width: 50, height: 200 },
                    { x: 2750, y: 2600, width: 50, height: 200 }
                ]);
            }
        }
        
        function addResourceDeposits(deposits) {
            deposits.forEach((deposit, index) => {
                // Create visual resource deposit markers (these would be implemented as entities)
                console.log(`Adding ${deposit.type} deposit at (${deposit.x}, ${deposit.y})`);
                // TODO: Implement actual resource deposit entities when resource system is expanded
            });
        }
        
        function addBarriers(barriers) {
            barriers.forEach((barrier, index) => {
                // Create defensive barrier/terrain objects
                console.log(`Adding barrier at (${barrier.x}, ${barrier.y}) size ${barrier.width}x${barrier.height}`);
                // TODO: Implement actual barrier entities for strategic positioning
            });
        }

        // Settings Modal Functions
        function showSettingsModal() {
            document.getElementById('gameSettingsModal').style.display = 'flex';
            
            // Update time elapsed
            updateTimeElapsed();
            
            // Update pause button text based on current state
            const pauseBtn = document.getElementById('pauseButtonText');
            if (window.game && window.game.engine) {
                pauseBtn.textContent = window.game.engine.isPaused ? '‚ñ∂Ô∏è Resume Game' : '‚è∏Ô∏è Pause Game';
            }
        }

        function updateTimeElapsed() {
            if (gameStartTime) {
                const elapsed = Date.now() - gameStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timeElapsed').textContent = timeString;
            }
        }
        
        let destroyedBasesCount = 0; // Track destroyed bases
        let allBasesSpawned = false; // Track if all bases have been spawned
        let expectedBases = 9; // Expected number of AI bases for legendary mode
        let gameEnded = false; // Prevent multiple game end triggers
        
        function checkPlayerDefeat() {
            if (gameEnded || !window.game || !window.game.engine) return;
            
            // Check if player's HQ/base is destroyed
            const playerBases = window.game.engine.entities.filter(entity => 
                entity.constructor.name === 'Base' && 
                entity.team === 'player' &&
                !entity.isDead &&
                entity.health > 0
            );
            
            if (playerBases.length === 0) {
                gameEnded = true;
                setTimeout(() => {
                    let difficultyText;
                    if (selectedDifficulty === 'legendary') {
                        difficultyText = 'LEGENDARY MODE';
                    } else {
                        difficultyText = selectedDifficulty.toUpperCase();
                    }
                    const message = `üíÄ DEFEAT! Your headquarters has been destroyed in ${difficultyText}!`;
                    window.game.showGameOverModal(false, message);
                }, 100);
            }
        }
        
        function checkVictoryCondition() {
            if (gameEnded || !window.game || !window.game.engine) return;
            
            // Check for victory condition (destroy all enemy bases)
            const aliveEnemyBases = window.game.engine.entities.filter(entity => 
                entity.constructor.name === 'Base' && 
                entity.team === 'enemy' &&
                !entity.isDead &&
                entity.health > 0
            );
            
            // Debug: List all enemy bases with details
            if (aliveEnemyBases.length > 1) {
                console.log('DEBUG: Multiple enemy bases detected:');
                aliveEnemyBases.forEach((base, idx) => {
                    console.log(`  Base ${idx}: ID=${base.id}, pos=(${base.position?.x},${base.position?.y}), health=${base.health}/${base.maxHealth}`);
                });
            }
            
            console.log(`Victory check: ${aliveEnemyBases.length} enemy bases remaining`);
            
            if (aliveEnemyBases.length === 0) {
                gameEnded = true;
                setTimeout(() => {
                    let difficultyText;
                    if (selectedDifficulty === 'legendary') {
                        difficultyText = 'LEGENDARY MODE';
                    } else {
                        difficultyText = selectedDifficulty.toUpperCase();
                    }
                    const message = `üèÜ VICTORY! You destroyed all enemy bases in ${difficultyText}!`;
                    window.game.showGameOverModal(true, message);
                }, 100);
            }
        }
        
        function updateEnemyBaseCounter() {
            if (selectedDifficulty !== 'legendary' || !window.game || !window.game.engine) return;
            
            // Check for player defeat first
            checkPlayerDefeat();
            
            if (gameEnded) return; // Don't update counter if game has ended
            
            // Count current alive enemy bases
            const aliveEnemyBases = window.game.engine.entities.filter(entity => 
                entity.constructor.name === 'Base' && 
                entity.team === 'enemy' &&
                !entity.isDead &&
                entity.health > 0
            );
            
            // Check if all bases have spawned (wait for all bases to appear)
            if (!allBasesSpawned) {
                if (aliveEnemyBases.length >= expectedBases) {
                    allBasesSpawned = true;
                    console.log(`All 9 enemy bases have spawned - base counter now active`);
                } else {
                    // Still waiting for bases to spawn
                    document.getElementById('basesDestroyed').textContent = '0';
                    return;
                }
            }
            
            // Calculate destroyed bases from the total expected minus alive bases
            const currentAlive = aliveEnemyBases.length;
            destroyedBasesCount = expectedBases - currentAlive;
            
            document.getElementById('basesDestroyed').textContent = destroyedBasesCount.toString();
            
            // Check for victory condition
            if (destroyedBasesCount >= expectedBases) {
                gameEnded = true;
                setTimeout(() => {
                    let difficultyText;
                    if (selectedDifficulty === 'legendary') {
                        difficultyText = 'LEGENDARY MODE';
                    } else {
                        difficultyText = selectedDifficulty.toUpperCase();
                    }
                    const message = `üèÜ VICTORY! You destroyed all ${expectedBases} enemy bases in ${difficultyText}!`;
                    window.game.showGameOverModal(true, message);
                }, 100);
            }
        }

        function hideSettingsModal() {
            document.getElementById('gameSettingsModal').style.display = 'none';
        }

        function togglePause() {
            if (window.game && window.game.engine) {
                window.game.engine.pause();
                // Update button text
                const pauseBtn = document.getElementById('pauseButtonText');
                pauseBtn.textContent = window.game.engine.isPaused ? '‚ñ∂Ô∏è Resume Game' : '‚è∏Ô∏è Pause Game';
            }
        }

        function resetCamera() {
            if (window.game && window.game.engine) {
                // Find player base
                const playerBases = window.game.engine.entities.filter(entity => 
                    entity.constructor.name === 'Base' && entity.team === 'player'
                );
                if (playerBases.length > 0) {
                    const base = playerBases[0];
                    window.game.engine.setCameraPosition(base.position.x - 300, base.position.y - 300);
                }
            }
        }

        function exitGame() {
            if (confirm('Are you sure you want to exit the game? Your progress will be lost.')) {
                // Stop the game engine
                if (window.game && window.game.engine) {
                    window.game.engine.stop();
                }
                // Redirect to main menu
                window.location.href = 'index.html';
            }
        }

        // Add event listener for the settings button
        document.addEventListener('DOMContentLoaded', function() {
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', showSettingsModal);
            }
        });
    </script>

    <!-- Game Settings Modal -->
    <div id="gameSettingsModal" class="building-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Game Settings</h3>
                <button class="modal-close" onclick="hideSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section time-section">
                    <div class="time-elapsed">
                        <span class="time-label">Time Elapsed:</span>
                        <span id="timeElapsed" class="time-value">00:00</span>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Game Controls</h4>
                    <div class="settings-info">
                        <p><strong>WASD / Arrow Keys:</strong> Move camera</p>
                        <p><strong>Left Click:</strong> Select units/buildings</p>
                        <p><strong>Right Click:</strong> Move/Attack command</p>
                        <p><strong>A + Right Click:</strong> Attack-Move command</p>
                        <p><strong>Ctrl + Click:</strong> Multi-select</p>
                        <p><strong>Space:</strong> Pause/Unpause game</p>
                        <p><strong>ESC:</strong> Deselect all</p>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Game Actions</h4>
                    <div class="settings-controls">
                        <button class="modal-btn" onclick="togglePause()">
                            <span id="pauseButtonText">‚è∏Ô∏è Pause Game</span>
                        </button>
                        <button class="modal-btn" onclick="resetCamera()">
                            üìç Reset Camera to Base
                        </button>
                        <button class="modal-btn exit-btn" onclick="exitGame()">
                            üö™ Exit Game
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="building-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="gameOverTitle">Game Over</h3>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <div id="gameOverMessage" class="game-over-message"></div>
                    <div class="modal-grid">
                        <button class="modal-btn" onclick="window.location.href='/'">
                            üè† Return to Home
                        </button>
                        <button class="modal-btn" onclick="location.reload()">
                            üîÑ Play Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HQ Modal for Base Commands -->
    <div id="hqModal" class="building-modal" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Base Commands</h3>
          <button class="modal-close" onclick="window.game.closeAllModals()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="modal-section">
            <button class="modal-btn" id="spawnWarthogBtn">
              <span class="btn-icon">üöó</span> 
              <span class="btn-label">Spawn Warthog</span>
              <div class="btn-cost">150üí∞ 1‚ö° 3üë•</div>
            </button>
            <button class="modal-btn" id="upgradeBaseModalBtn">
              <span class="btn-icon">üîì</span> 
              <span class="btn-label">Upgrade Base</span>
              <div class="btn-cost">500üí∞ 2‚ö°</div>
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Simple handlers like in hqModal.html
      function setupHQModalHandlers() {
        console.log('Setting up HQ modal handlers...');
        
        const spawnWarthogBtn = document.getElementById('spawnWarthogBtn');
        if (spawnWarthogBtn) {
          console.log('‚úì Spawn Warthog button found');
          spawnWarthogBtn.onclick = function() {
            console.log('Spawn Warthog clicked');
            if (window.game && window.game.handleUnitProduction) {
              // Find and select player base
              const playerBase = window.game.engine.entities.find(entity => 
                entity.constructor.name === 'Base' && 
                entity.team === window.game.playerTeam && 
                !entity.isDead
              );
              if (playerBase) {
                window.game.engine.clearSelection();
                window.game.engine.selectEntity(playerBase);
                window.game.handleUnitProduction('warthog');
              }
            }
            window.game.closeAllModals();
          };
        }
        
        const upgradeBaseModalBtn = document.getElementById('upgradeBaseModalBtn');
        if (upgradeBaseModalBtn) {
          console.log('‚úì Upgrade Base button found');
          upgradeBaseModalBtn.onclick = function() {
            console.log('Upgrade Base clicked');
            if (window.game && window.game.upgradeBase) {
              window.game.upgradeBase();
            }
            window.game.closeAllModals();
          };
        }
      }
      
      // Setup handlers
      setupHQModalHandlers();
      document.addEventListener('DOMContentLoaded', setupHQModalHandlers);
    </script>
    <!-- End HQ Modal -->
</body>
</html>